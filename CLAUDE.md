# EasyCTF - Minecraft Capture The Flag Plugin

## プロジェクト Overview

EasyCTFは、Minecraft Paper Server用のCapture The Flag（CTF）プラグインです。複数のCTFゲームを同時に管理・実行でき、各ゲームでRed TeamとBlue Teamに分かれて旗を取り合う対戦を行います。マッチシステムにより複数ゲームを連続して実行し、最終的な勝者を決定できます。

## プロジェクト構成

```
src/main/kotlin/com/hacklab/ctf/
├── Main.kt                      # メインプラグインクラス
├── Game.kt                      # 個別ゲームの実装
├── Match.kt                     # マッチシステムの実装
├── commands/
│   └── CTFCommandNew.kt         # コマンド処理
├── listeners/
│   ├── GameListenerNew.kt       # ゲームイベント処理
│   └── ChatListener.kt          # チャット処理
├── managers/
│   ├── GameManagerNew.kt        # ゲーム状態管理
│   ├── EquipmentManager.kt      # 装備管理
│   └── LanguageManager.kt       # 多言語対応
├── shop/
│   ├── ShopManager.kt           # ショップシステム
│   └── ShopItem.kt              # ショップアイテム定義
└── utils/
    ├── GameState.kt             # ゲーム状態定義
    ├── GamePhase.kt             # ゲームフェーズ定義
    ├── Team.kt                  # チーム定義
    └── MatchMode.kt             # マッチモード定義

src/main/resources/
├── plugin.yml                   # プラグイン設定
├── config.yml                   # グローバル設定
├── lang_ja.yml                  # 日本語メッセージ
└── lang_en.yml                  # 英語メッセージ
```

## 技術スタック

- **言語**: Kotlin 1.9.22
- **プラットフォーム**: Minecraft Paper API 1.21.5
- **ビルドツール**: Gradle with Kotlin DSL
- **JVM**: Java 21

## 主要システム

### 1. マッチシステム
複数のゲームを連続して実行し、総合的な勝者を決定するシステム。

#### マッチモード
固定ラウンドモードのみサポート：指定した回数のゲームを実施し、最多勝利チームが優勝

#### マッチ機能
- ゲーム間のインターバル（デフォルト15秒）
- プレイヤーの自動引き継ぎ
- マッチ全体のスコア管理
- BossBarによるマッチ進行状況表示

### 2. ショップシステム
チーム共有通貨（G）を使用してアイテムを購入できるシステム。

#### 通貨システム
- **チーム共有**: 同じチームのメンバーが通貨を共有
- **初期通貨**: 各ゲーム開始時に50G（設定可能）
- **通貨獲得方法**:
  - キル報酬: 10G（旗キャリアキル: 20G）
  - キャプチャ報酬: 30G
  - フェーズ終了ボーナス: 50G

#### ショップアイテムカテゴリ
- **武器**: 鉄/ダイヤ/ネザライトの剣・斧、弓、盾
- **防具**: 鉄/ダイヤ/ネザライトの防具セット
- **消耗品**: エンダーパール、金のリンゴ、矢
- **建築ブロック**: 石、木材、土、砂、ガラス、黒曜石、TNTなど

#### 割引システム
スコア差に応じて負けているチームに割引を適用：
- 1点差: 10%割引
- 2点差: 20%割引
- 3点差: 30%割引
- 4点差以上: 40%割引

#### 死亡時のアイテム処理
- **KEEP**: 死亡しても保持
- **DROP**: 死亡時にドロップ
- **DESTROY**: 死亡時に消失

### 3. 多言語対応
- 日本語（ja）と英語（en）に対応
- config.ymlで言語設定を変更可能
- メッセージファイル: lang_ja.yml, lang_en.yml

### 4. 複数ゲーム管理
- **同時実行**: 無制限（サーバーリソースの範囲内）
- **プレイヤー制限**: 各プレイヤーは同時に1つのゲームのみ参加可能
- **ワールド**: 全ゲームが同一ワールドで実行される
- **ゲーム名制約**:
  - 使用可能文字: 英数字とアンダースコア（`a-z`, `A-Z`, `0-9`, `_`）
  - 最大長: 32文字
  - 予約語: `all`, `list`, `help`は使用不可
  - 大文字小文字を区別しない

### 5. ゲーム設定の永続化
- **保存形式**: YAML形式
- **保存場所**: `plugins/EasyCTF/games/<ゲーム名>.yml`
- **自動保存**: ゲーム作成・設定変更時に自動保存
- **自動読み込み**: サーバー起動時に全ゲーム設定を読み込み

## ゲーム仕様

### チーム構成
- **Red Team**: 赤チーム（最大10名）
- **Blue Team**: 青チーム（最大10名）
- **チーム割り当て**: 自動バランス（参加時に人数が少ない方に自動割り当て）

### ゲーム状態
- `WAITING`: プレイヤー待機中
- `STARTING`: ゲーム開始準備中
- `RUNNING`: ゲーム進行中
- `ENDING`: ゲーム終了処理中
- `CONFIGURING`: 対話形式での設定中

### ゲームフェーズ
1. **BUILD PHASE（建築フェーズ）**
   - 時間: デフォルト120秒（2分、設定可能）
   - ゲームモード: ADVENTURE/SURVIVAL/CREATIVE（選択可能）
   - ショップアイテム使用可能
   - 戦闘は禁止
   - **ブロック接続システム**: ブロックは自チームのビーコンまたは既存のチームブロックに接続必須
   - **切断ブロックの中立化**: 接続が切れたブロックは白色（クォーツブロック）に変化

2. **COMBAT PHASE（戦闘フェーズ）**
   - 時間: デフォルト120秒（2分、設定可能）
   - CTF本戦、旗の奪取と得点
   - ショップ使用可能（スポーン地点付近のみ）
   - PvP強制有効化（設定可能）
   - **敵陣ダメージシステム**: 敵チームブロック上で継続的にダメージを受ける
   - **ブロック破壊**: 特定のツールでのみ可能（config.ymlで設定）
     - デフォルト: ピッケル、シャベル、バケツ
     - 旗・スポーン装飾は破壊不可

3. **INTERMISSION PHASE（作戦会議フェーズ）**
   - 時間: デフォルト15秒（設定可能）
   - 試合結果の表示
   - マッチモード時は次ゲームへの準備
   - **注意**: マッチの中間と最終で異なる時間設定が可能
     - `result-duration`: 最終ゲーム後の時間（デフォルト15秒）
     - `intermediate-result-duration`: マッチ中間の時間（デフォルト15秒）

### 旗システム
- **実装**: ビーコン（3x3の鉄ブロックベース付き）
- **旗取得**: 敵ビーコンに1.5ブロック以内で接近
- **旗キャリア効果**: 発光、移動制限（エンダーパール等使用不可）
- **得点条件**: 自陣の旗がある状態で敵旗を持ち帰る
- **ドロップ処理**: 死亡時にその場にドロップ（30秒で自動復帰）

### 初期装備
- 石の剣
- 石の斧
- パン×8
- チーム色の革防具（変更不可）
- エメラルド（ショップアイテム）


## コマンド仕様

### 基本コマンド: `/ctf`

| サブコマンド | 権限 | 説明 |
|-------------|------|------|
| `create <ゲーム名>` | `ctf.admin` | 新規ゲーム作成（対話形式） |
| `update <ゲーム名>` | `ctf.admin` | 既存ゲーム設定の更新（対話形式） |
| `delete <ゲーム名>` | `ctf.admin` | ゲーム削除 |
| `list` | `ctf.use` | 全ゲーム一覧表示 |
| `start <ゲーム名> [match] [ゲーム数]` | `ctf.admin` | ゲーム/マッチ開始 |
| `stop <ゲーム名>` | `ctf.admin` | ゲーム/マッチ強制停止 |
| `join <ゲーム名>` | `ctf.use` | ゲーム参加 |
| `leave` | `ctf.use` | 現在のゲームから離脱 |
| `team [red\|blue]` | `ctf.use` | チーム確認・変更（開始前のみ） |
| `spectator [ゲーム名]` | `ctf.use` | 観戦者として参加 |
| `setflag <ゲーム名> <red\|blue>` | `ctf.admin` | 旗位置設定 |
| `setspawn <ゲーム名> <red\|blue>` | `ctf.admin` | スポーン地点設定 |
| `addspawn <ゲーム名> <red\|blue>` | `ctf.admin` | スポーン地点追加 |
| `removespawn <ゲーム名> <red\|blue> <番号>` | `ctf.admin` | スポーン地点削除 |
| `listspawns <ゲーム名>` | `ctf.admin` | スポーン地点一覧表示 |
| `setpos1 [ゲーム名]` | `ctf.admin` | マップ領域始点設定 |
| `setpos2 [ゲーム名]` | `ctf.admin` | マップ領域終点設定 |
| `savemap <ゲーム名>` | `ctf.admin` | マップ保存（自動検出） |
| `status [ゲーム名]` | `ctf.use` | ゲーム状態確認 |
| `info <ゲーム名>` | `ctf.use` | ゲーム詳細情報表示 |

### マッチ開始コマンド
```
/ctf start <ゲーム名> [match] [ゲーム数]
```
- `match`: マッチモードを指定（例: `/ctf start game1 match 5` → 5ゲーム実施）
- ゲーム数省略時: config.ymlのデフォルト設定（3ゲーム）を使用
- マッチ指定なし: 単一ゲームとして実行

### ショップの使用方法
1. インベントリのエメラルドを右クリック
2. スポーン地点から15ブロック以内で使用可能
3. チームの共有通貨でアイテムを購入

### マップ作成システム（新機能）

#### 自動検出方式
マップ領域を指定し、特定のブロックを自動検出して設定を行う方式：

1. **マップ領域の設定**
   ```
   /ctf setpos1 <ゲーム名>  # 現在地を始点として設定
   /ctf setpos2 <ゲーム名>  # 現在地を終点として設定
   ```

2. **マップの保存と自動検出**
   ```
   /ctf savemap <ゲーム名>
   ```
   以下のブロックを自動検出：
   - **赤のコンクリート**: 赤チームのスポーン地点（1つ以上、複数可）
   - **青のコンクリート**: 青チームのスポーン地点（1つ以上、複数可）
   - **ビーコン + 赤のガラス**: 赤チームの旗位置（1つのみ）
   - **ビーコン + 青のガラス**: 青チームの旗位置（1つのみ）

3. **エラー処理**
   - 必要なブロックが見つからない場合はエラー
   - 旗（ビーコン）が複数ある場合はエラー
   - スポーン地点同士の距離が4ブロック未満の場合はエラー
   - 旗とスポーンの距離が3ブロック未満の場合はエラー

4. **マップデータの保存**
   - 領域内のすべてのブロックが保存される
   - **圧縮形式**: GZIP圧縮 + Base64エンコードで効率的に保存
   - 保存場所: `plugins/EasyCTF/maps/<ゲーム名>.yml`
   - AIR以外のブロックのみ保存（効率化）

5. **テンポラリワールドシステム**
   - **ゲーム開始時**: 専用のテンポラリワールド（`ctf_temp_<ゲーム名>`）を作成
   - **マップ復元**: 保存されたマップをテンポラリワールドに復元
   - **プレイヤー転送**: 全プレイヤーをテンポラリワールドへ自動転送
   - **ゲーム終了時**: プレイヤーを元のワールドに戻し、テンポラリワールドを削除
   - **メリット**: 
     - 複数のゲームが完全に独立して実行可能
     - 元のワールドに影響を与えない
     - マップリセットが不要（毎回新しいワールド）

### 対話形式ゲーム作成（従来方式）
`/ctf create <ゲーム名>` 実行後、以下の順序で対話的に設定：

1. **赤チーム旗位置**
   - プロンプト: "赤チームの旗を設置する場所を見て、チャットで 'set' と入力してください"
   - 視線先のブロックを旗位置として設定

2. **赤チームスポーン地点**
   - プロンプト: "赤チームのスポーン地点を見て、チャットで 'set' と入力してください"
   - 視線先のブロックをスポーン地点として設定

3. **青チーム旗位置**
   - プロンプト: "青チームの旗を設置する場所を見て、チャットで 'set' と入力してください"
   - 視線先のブロックを旗位置として設定

4. **青チームスポーン地点**
   - プロンプト: "青チームのスポーン地点を見て、チャットで 'set' と入力してください"
   - 視線先のブロックをスポーン地点として設定

5. **建築フェーズゲームモード**
   - プロンプト: "建築フェーズのゲームモードを選択してください (ADVENTURE/SURVIVAL/CREATIVE)"
   - デフォルト: SURVIVAL

6. **建築フェーズ時間**
   - プロンプト: "建築フェーズの時間を秒単位で入力してください (例: 120)"
   - デフォルト: 120秒（2分）

7. **戦闘フェーズ時間**
   - プロンプト: "戦闘フェーズの時間を秒単位で入力してください (例: 120)"
   - デフォルト: 120秒（2分）

**対話中の操作**：
- `cancel`: 作成をキャンセル
- `skip`: 現在の設定をスキップ（デフォルト値を使用）
- タイムアウト: 60秒間無応答で自動キャンセル
- プレイヤー切断: 自動的にキャンセル（設定は保存されない）

### 対話形式ゲーム更新
`/ctf update <ゲーム名>` 実行後、更新メニューを表示：

**更新メニュー**:
1. 赤チーム旗位置を更新
2. 赤チームスポーン地点を更新
3. 青チーム旗位置を更新
4. 青チームスポーン地点を更新
5. 建築フェーズゲームモードを更新
6. 建築フェーズ時間を更新
7. 戦闘フェーズ時間を更新
8. すべて更新（create と同じ手順）
9. 終了

**更新の流れ**:
- メニュー番号を入力して項目を選択
- 選択した項目のみ更新（他の設定は維持）
- 更新後、メニューに戻る（複数項目の更新が可能）
- `9` または `exit` で更新を終了

**注意事項**:
- 実行中のゲームは更新不可（停止中のみ）
- 更新内容は即座にYAMLファイルに保存
- 位置設定の距離検証は更新時も実行
- スポーン地点は省略可能（旗位置にフォールバック）

### 位置設定の仕様
- **視線検出**: プレイヤーが見ている方向の最初の固体ブロック
- **最大検出距離**: 100ブロック
- **エラー処理**: 範囲内にブロックがない場合はエラーメッセージ表示
- **座標確認**: 設定時に座標を表示して確認
- **距離検証**: 旗とスポーン地点の最小距離チェック（3ブロック以上）

### 権限システム
- `ctf.use`: 基本コマンド使用権限（デフォルト: true）
- `ctf.admin`: 管理者コマンド使用権限（デフォルト: op）
- `ctf.*`: 全権限（デフォルト: op）

## ゲーム運用仕様

### 自動開始
- min-players到達で30秒カウントダウン後に開始
- 人数が下回るとカウントダウンキャンセル

### プレイヤー切断・再接続
- 切断時: チーム所属維持、旗ドロップ
- 再接続時: 元のゲーム・チームに自動復帰

### スポーン保護
- リスポーン後3秒間無敵
- 攻撃または旗取得で即座に解除

### UI表示
- **スコアボード**: ゲーム情報、スコア、残り時間、チーム人数
- **BossBar**: 現在のフェーズと残り時間（マッチ時は進行状況も表示）
- **ActionBar**: エラーメッセージや状態通知

### 権限システム
- `ctf.use`: 基本コマンド使用権限（デフォルト: true）
- `ctf.admin`: 管理者コマンド使用権限（デフォルト: op）
- `ctf.*`: 全権限（デフォルト: op）

## 設定ファイル

### config.yml（主要設定）
```yaml
# 言語設定
language: "ja"  # "en" または "ja"

# デフォルトゲーム設定
default-game:
  min-players: 2
  max-players-per-team: 10
  respawn-delay: 5
  force-pvp: true

# フェーズ設定
default-phases:
  build-duration: 300        # 建築フェーズ（秒）
  build-phase-gamemode: "ADVENTURE"
  combat-duration: 600       # 戦闘フェーズ（秒）
  result-duration: 15        # 作戦会議フェーズ（秒）
  intermediate-result-duration: 15  # マッチ中間の作戦会議（秒）

# マッチ設定
match:
  default-target: 3          # デフォルトゲーム数
  interval-duration: 30      # ゲーム間インターバル（秒）

# 通貨設定
currency:
  name: "G"
  initial: 50                # 初期通貨
  phase-end-bonus: 50        # フェーズ終了ボーナス
  kill-reward: 10            # キル報酬
  carrier-kill-reward: 20    # 旗キャリアキル報酬
  capture-reward: 30         # キャプチャ報酬

# ショップ設定
shop:
  enabled: true
  use-range: 15              # スポーンからの使用可能距離
  discount:
    1-point: 0.1            # 1点差で10%割引
    2-point: 0.2            # 2点差で20%割引
    3-point: 0.3            # 3点差で30%割引
    4-point-plus: 0.4       # 4点差以上で40%割引

# 初期装備
initial-equipment:
  weapons:
    - "STONE_SWORD"
    - "STONE_AXE"
  food:
    - "BREAD:8"
```

### ゲーム個別設定（games/<ゲーム名>.yml）
```yaml
name: "example_game"
created: "2025-01-05T12:00:00"
world: "world"

teams:
  red:
    flag-location: 
      x: 100
      y: 64
      z: 0
    spawn-location:
      x: 90
      y: 64
      z: 0
  blue:
    flag-location:
      x: -100
      y: 64
      z: 0
    spawn-location:
      x: -90
      y: 64
      z: 0

settings:
  min-players: 4
  max-players-per-team: 8
  phases:
    build-duration: 240
    combat-duration: 480
    build-phase-gamemode: "SURVIVAL"
```

## 開発・ビルド手順

### 前提条件
- Java 21
- Gradle 8.3+
- Paper Server 1.21.5

### ビルドコマンド
```bash
# プロジェクトビルド
./gradlew build

# プラグインJAR作成
./gradlew shadowJar

# 開発サーバー起動
./gradlew runServer
```

### 生成ファイル
- `build/libs/easy_ctf-1.0-SNAPSHOT-all.jar` - プラグインファイル


## トラブルシューティング

### よくある問題

1. **ショップが開かない**: スポーン地点から15ブロック以内で使用
2. **通貨が共有されない**: 同じチームか確認
3. **マッチが進行しない**: ゲーム設定（旗・スポーン）が完了しているか確認
4. **言語が変わらない**: config.ymlのlanguage設定後、サーバー再起動が必要

### デバッグ設定
```yaml
debug:
  enabled: true
  log-level: "INFO"
```

## 今後の拡張予定

1. **統計システム**: プレイヤー個人成績の追跡・ランキング
2. **マップローテーション**: 複数マップの自動切り替え
3. **カスタムアビリティ**: 特殊能力やクラスシステム
4. **トーナメントモード**: 複数チームでのトーナメント形式
5. **Web API**: 統計情報の外部連携

## ライセンス

このプロジェクトは学習・研究目的で作成されています。