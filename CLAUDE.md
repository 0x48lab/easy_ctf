# EasyCTF - Minecraft Capture The Flag Plugin

## プロジェクト Overview

EasyCTFは、Minecraft Paper Server用のCapture The Flag（CTF）プラグインです。複数のCTFゲームを同時に管理・実行でき、各ゲームでRed TeamとBlue Teamに分かれて旗を取り合う対戦を行います。

## プロジェクト構成

```
src/main/kotlin/com/hacklab/ctf/
├── Main.kt                    # メインプラグインクラス
├── commands/
│   └── CTFCommand.kt         # コマンド処理
├── listeners/
│   └── GameListener.kt       # ゲームイベント処理
├── managers/
│   └── GameManager.kt        # ゲーム状態管理
└── utils/
    ├── GameState.kt          # ゲーム状態定義
    ├── GamePhase.kt          # ゲームフェーズ定義
    └── Team.kt               # チーム定義

src/main/resources/
├── plugin.yml                # プラグイン設定
└── config.yml                # ゲーム設定
```

## 技術スタック

- **言語**: Kotlin 1.9.22
- **プラットフォーム**: Minecraft Paper API 1.21.5
- **ビルドツール**: Gradle with Kotlin DSL
- **JVM**: Java 21

## 複数ゲーム管理システム

### ゲーム管理仕様
- **同時実行**: 無制限（サーバーリソースの範囲内）
- **プレイヤー制限**: 各プレイヤーは同時に1つのゲームのみ参加可能
- **ワールド**: 全ゲームが同一ワールドで実行される
- **ゲーム名制約**:
  - 使用可能文字: 英数字とアンダースコア（`a-z`, `A-Z`, `0-9`, `_`）
  - 最大長: 32文字
  - 予約語: `all`, `list`, `help`は使用不可
  - 大文字小文字を区別しない

### ゲーム設定の永続化
- **保存形式**: YAML形式
- **保存場所**: `plugins/EasyCTF/games/<ゲーム名>.yml`
- **自動保存**: ゲーム作成・設定変更時に自動保存
- **自動読み込み**: サーバー起動時に全ゲーム設定を読み込み

## ゲーム仕様

### チーム構成
- **Red Team**: 赤チーム（最大10名）
- **Blue Team**: 青チーム（最大10名）
- **チーム割り当て**: 自動バランス（参加時に人数が少ない方に自動割り当て、同数の場合はランダム）

### ゲーム状態
- `WAITING`: プレイヤー待機中
- `STARTING`: ゲーム開始準備中
- `RUNNING`: ゲーム進行中
- `ENDING`: ゲーム終了処理中
- `CONFIGURING`: 対話形式での設定中（create/update実行中）

### ゲームフェーズ
ゲームは3つのフェーズで構成されます：

1. **BUILD PHASE（建築フェーズ）**
   - 時間: デフォルト5分（設定可能）
   - 内容: プレイヤーは建築ツールとブロックを配布され、防御設備を構築
   - 装備: 木製ツール、建築ブロック（石、木材、土）
   - 制限: 戦闘は禁止、旗は配置されない
   - **ゲームモード**: 設定可能（ADVENTURE/SURVIVAL/CREATIVE）
     - `ADVENTURE`: 限定的な操作のみ、プログラミング建築向け（デフォルト）
     - `SURVIVAL`: 通常の建築・破壊が可能
     - `CREATIVE`: 無制限建築、飛行、瞬時破壊が可能

2. **COMBAT PHASE（戦闘フェーズ）**
   - 時間: デフォルト10分（設定可能）
   - 内容: CTFの本戦、相手チームの旗を奪取して自陣に持ち帰る
   - 装備: チーム色防具、鉄剣、弓矢、食料
   - 目標: 敵の旗をキャプチャしてスコアを獲得

3. **RESULT PHASE（リザルトフェーズ）**
   - 時間: デフォルト1分（設定可能）
   - 内容: 試合結果の表示、勝利チームの発表
   - 制限: 戦闘・移動制限、装備没収

### ゲームルール
1. **目標**: 相手チームの旗を取って自陣に持ち帰る
2. **勝利条件**: 戦闘フェーズ終了時に得点が多いチームが勝利（同点は引き分け）
3. **得点**: 戦闘フェーズ中に何度でも得点可能
4. **時間制限**: 各フェーズ時間設定（建築5分、戦闘10分、結果1分）
5. **最小プレイヤー数**: 
   - 手動開始: 2名必須（未満は開始不可）
   - 自動開始: config.ymlのmin-players到達時に自動開始
6. **装備**: チーム色の革防具を自動装備
7. **リスポーン**: 死亡後5秒でリスポーン
8. **プレイヤー転送**: ゲーム開始時・フェーズ遷移時に自陣リスポン地点に自動転送

### 旗システム
- **旗の実装**: ビーコンのみ（プレイヤーが周囲を装飾可能）
- **ビーコンベース**: ビーコンの下に3x3の鉄ブロック床を自動設置（ビーム有効化）
- **ビーコンビーム**: ビーコンの上にチーム色（赤/青）のステンドグラスを設置して着色
- **配置タイミング**: ゲーム開始時（建築フェーズ開始時）に自動設置
- **破壊制限**:
  - 建築フェーズ: ビーコン、ベース、色付きガラスは破壊不可（防御施設の構築目標として）
  - 戦闘フェーズ: 全ブロック破壊不可
- **旗の取得**: 戦闘フェーズ中に敵の旗（ビーコン）に1.5ブロック以内に近づくと取得
- **旗キャリア**: 
  - 旗（ビーコン）を持ったプレイヤーは発光効果
  - 使用制限: エンダーパール、エリトラ、乗り物（馬、ボート等）使用不可
  - 旗を持っている間は常に攻撃対象（安全地帯なし）
- **旗のドロップ処理**:
  - キャリアが死亡・切断: その場にドロップ（アイテム化）
  - 自チームが拾う: 即座に元の位置に復活（ビーコン再設置）
  - 敵チームが拾う: そのまま旗運搬を継続
  - 30秒間放置: 自動的に元の位置に復活
- **得点条件**: 
  - 敵の旗を自陣の旗位置（3ブロック以内）に持ち帰る
  - **重要**: 自チームの旗が自陣にある場合のみ得点可能
  - 自チームの旗が敵に奪われている、またはドロップ中の場合は得点不可
- **旗の再設置**: 得点後、即座に元の位置に自動再配置

### プレイヤー転送システム
- **ゲーム開始時**: 全プレイヤーを自陣リスポン地点に転送
- **フェーズ遷移時**: 戦闘フェーズ・結果フェーズ開始時に自陣リスポン地点に転送
- **死亡時**: 自陣リスポン地点でリスポーン
- **フォールバック機能**: 
  - スポーン地点未設定時は自動的に旗の位置にスポーン
  - 優先順位: 1) スポーン地点 2) 旗位置 3) ワールドスポーン
- **エラーハンドリング**: 旗位置も未設定時のみ警告メッセージを表示
- **ログ記録**: 転送処理の成功・失敗、フォールバック使用をサーバーログに記録

### スポーン保護システム
- **スポーン無敵時間**: リスポーン後3秒間のダメージ無効
- **適用条件**: 
  - 死亡後のリスポーン時のみ（ゲーム開始時は適用なし）
  - 攻撃を行うと即座に無敵解除
  - 旗を拾うと即座に無敵解除
- **視覚効果**: 無敵中はパーティクルエフェクトで表示
- **スポーン地点装飾**: 
  - ビーコン（スポーン地点の1ブロック上）
  - チーム色ウールブロック（3x3のビーコンベース）
  - チーム色コンクリート（3x3の足元）
  - ゲーム終了時に自動削除

### 距離制限システム
- **旗・スポーン間距離制限**: 旗とスポーン地点が近すぎる設定を防止
- **最小距離設定**: config.ymlで最小距離を設定可能（デフォルト15ブロック）
- **クロスチーム検証**: 他チームの旗・スポーンとの距離もチェック
- **リアルタイム検証**: 設定コマンド実行時に即座に距離をチェック

## コマンド仕様

### 基本コマンド: `/ctf`

| サブコマンド | 権限 | 説明 |
|-------------|------|------|
| `create <ゲーム名>` | `ctf.admin` | 新規ゲーム作成（対話形式） |
| `update <ゲーム名>` | `ctf.admin` | 既存ゲーム設定の更新（対話形式） |
| `delete <ゲーム名>` | `ctf.admin` | ゲーム削除 |
| `list` | `ctf.use` | 全ゲーム一覧表示 |
| `start <ゲーム名>` | `ctf.admin` | 指定ゲーム開始 |
| `stop <ゲーム名>` | `ctf.admin` | 指定ゲーム強制停止（全プレイヤー退出） |
| `join <ゲーム名>` | `ctf.use` | ゲーム参加（チーム自動割り当て、既参加時は確認） |
| `leave` | `ctf.use` | 現在のゲームから離脱 |
| `setflag <ゲーム名> <red\|blue>` | `ctf.admin` | 旗の位置設定（視線先のブロック） |
| `setspawn <ゲーム名> <red\|blue>` | `ctf.admin` | スポーン地点設定（視線先のブロック） |
| `status [ゲーム名]` | `ctf.use` | ゲーム状態確認（省略時は参加中のゲーム） |

### 対話形式ゲーム作成
`/ctf create <ゲーム名>` 実行後、以下の順序で対話的に設定：

1. **赤チーム旗位置**
   - プロンプト: "赤チームの旗を設置する場所を見て、チャットで 'set' と入力してください"
   - 視線先のブロックを旗位置として設定

2. **赤チームスポーン地点**
   - プロンプト: "赤チームのスポーン地点を見て、チャットで 'set' と入力してください"
   - 視線先のブロックをスポーン地点として設定

3. **青チーム旗位置**
   - プロンプト: "青チームの旗を設置する場所を見て、チャットで 'set' と入力してください"
   - 視線先のブロックを旗位置として設定

4. **青チームスポーン地点**
   - プロンプト: "青チームのスポーン地点を見て、チャットで 'set' と入力してください"
   - 視線先のブロックをスポーン地点として設定

5. **建築フェーズゲームモード**
   - プロンプト: "建築フェーズのゲームモードを選択してください (ADVENTURE/SURVIVAL/CREATIVE)"
   - デフォルト: ADVENTURE

6. **建築フェーズ時間**
   - プロンプト: "建築フェーズの時間を秒単位で入力してください (例: 300)"
   - デフォルト: 300秒（5分）

7. **戦闘フェーズ時間**
   - プロンプト: "戦闘フェーズの時間を秒単位で入力してください (例: 600)"
   - デフォルト: 600秒（10分）

**対話中の操作**：
- `cancel`: 作成をキャンセル
- `skip`: 現在の設定をスキップ（デフォルト値を使用）
- タイムアウト: 60秒間無応答で自動キャンセル
- プレイヤー切断: 自動的にキャンセル（設定は保存されない）

### 対話形式ゲーム更新
`/ctf update <ゲーム名>` 実行後、更新メニューを表示：

**更新メニュー**:
1. 赤チーム旗位置を更新
2. 赤チームスポーン地点を更新
3. 青チーム旗位置を更新
4. 青チームスポーン地点を更新
5. 建築フェーズゲームモードを更新
6. 建築フェーズ時間を更新
7. 戦闘フェーズ時間を更新
8. すべて更新（create と同じ手順）
9. 終了

**更新の流れ**:
- メニュー番号を入力して項目を選択
- 選択した項目のみ更新（他の設定は維持）
- 更新後、メニューに戻る（複数項目の更新が可能）
- `9` または `exit` で更新を終了

**注意事項**:
- 実行中のゲームは更新不可（停止中のみ）
- 更新内容は即座にYAMLファイルに保存
- 位置設定の距離検証は更新時も実行
- スポーン地点は省略可能（旗位置にフォールバック）

### 位置設定の仕様
- **視線検出**: プレイヤーが見ている方向の最初の固体ブロック
- **最大検出距離**: 100ブロック
- **エラー処理**: 範囲内にブロックがない場合はエラーメッセージ表示
- **座標確認**: 設定時に座標を表示して確認
- **距離検証**: 旗とスポーン地点の最小距離チェック（15ブロック以上）

### 権限システム
- `ctf.use`: 基本コマンド使用権限（デフォルト: true）
- `ctf.admin`: 管理者コマンド使用権限（デフォルト: op）
- `ctf.*`: 全権限（デフォルト: op）

## ゲーム運用仕様

### ゲーム名の管理
- **重複チェック**: 同名のゲーム作成は拒否（エラーメッセージ表示）
- **大文字小文字**: 区別しない（`Game1`と`game1`は同一扱い）
- **保存形式**: ファイル名は小文字に統一

### 対話形式の入力処理
- **大文字小文字**: 区別しない（`yes`/`YES`/`Yes`すべて受付）
- **コマンド例**: `set`/`SET`/`Set`すべて有効
- **数値入力**: 半角数字のみ受付

### チーム満員時の処理
- **片方満員**: もう一方のチームに自動割り当て
- **両方満員**: 参加拒否（エラーメッセージ表示）
- **メッセージ**: "ゲームが満員です（最大20名）"

### 自動開始の仕様
- **開始条件**: min-players到達時
- **カウントダウン**: 30秒のカウントダウン後に開始
- **通知**: 参加者全員にカウントダウンを表示
- **キャンセル**: 人数が下回った場合は自動開始をキャンセル

### スコアボードの管理
- **既存スコアボード**: CTF用に上書き（警告なし）
- **ゲーム終了時**: スコアボードを削除
- **複数ゲーム対応**: 参加中のゲームのスコアボードのみ表示

### 途中参加とゲーム終了
- **途中参加**: ゲーム実行中は参加不可（待機中のみ参加可能）
- **ゲーム終了時**: 全プレイヤーを自動的に退出
- **強制停止（/ctf stop）**: ゲームを即座に停止し、全プレイヤーを退出
- **ゲーム終了時の装備**: 自動的に削除（インベントリをクリア）
- **終了後の処理**: 退出後、プレイヤーはワールドスポーン地点に転送

### ゲーム参加の制約
- **重複参加の処理**:
  - 既に他のゲームに参加中の場合、確認ダイアログを表示
  - プロンプト: "既に<現在のゲーム名>に参加中です。退出して<新しいゲーム名>に参加しますか？(yes/no)"
  - `yes` 選択時: 現在のゲームから自動退出して新しいゲームに参加
  - `no` 選択時: 参加をキャンセル
  - タイムアウト: 30秒（自動的に`no`扱い）

### プレイヤーの切断・再接続処理
- **切断時の処理**:
  - チーム所属は維持（退出しない）
  - 旗を持っていた場合: その場にドロップ
  - スコアボードに「切断中」と表示
- **再接続時の処理**:
  - 自動的に元のゲーム・チームに復帰
  - 現在のフェーズに応じた装備を再配布
  - チームのスポーン地点に転送

### ゲーム削除の制約
- **実行中のゲーム**: 自動的に停止してから削除
- **プレイヤー参加中**: 全プレイヤーを強制退出後、削除
- **設定ファイル**: YAMLファイルも同時に削除
- **削除の流れ**: ゲーム停止 → プレイヤー退出 → データ削除 → ファイル削除

### サーバー再起動時の処理
- **実行中のゲーム**: 強制終了（再開不可）
- **プレイヤー状態**: 全員ゲームから退出した状態に
- **ゲーム状態**: `WAITING`に戻る
- **設定**: YAMLファイルから復元（位置設定等は保持）

### ゲーム開始の最小要件
- **必須設定**: 両チームの旗位置
- **オプション**: スポーン地点（未設定時は旗位置にフォールバック）
- **片方のみ設定**: ゲーム開始不可（エラーメッセージ表示）

### ゲーム一覧表示（/ctf list）
表示形式:
```
===== CTFゲーム一覧 =====
1. game_alpha [実行中] - 赤: 3名, 青: 4名
2. game_beta [待機中] - 赤: 0名, 青: 0名
3. game_gamma [設定中] - 旗未設定
```
- ゲーム名
- 状態（待機中/実行中/設定中）
  - 設定中: create/updateコマンドの対話中
- 各チームの参加人数
- 設定状況の警告

### エリア重複時の処理
- **旗の独立性**: 各ゲームの旗はゲーム固有のメタデータを持つ
- **誤取得防止**: 他ゲームの旗には触れない（クリック無効）
- **視覚的区別**: 参加中のゲームの旗のみハイライト表示

### 設定検証のタイミング
- **設定時**: 即座に距離検証を実行
- **ゲーム開始時**: 全設定を再検証
- **更新時**: 変更された設定のみ検証

## 主要機能

### 1. ゲーム管理
- 複数ゲームの同時管理・実行
- ゲーム設定の永続化（YAML）
- プレイヤーの参加ゲーム追跡

### 2. チーム管理
- 自動チームバランス機能
- チーム色の防具自動配布
- チーム別スポーン地点
- チーム人数制限の自動チェック

### 3. 旗システム
- 旗の配置・回収システム
- 旗キャリア追跡
- 旗状態の表示

### 4. スコアボード
- ゲーム参加時に自動表示
- リアルタイムスコア表示
- 残り時間表示
- チーム情報表示
- ゲーム名表示

### 5. BossBar
- 現在のフェーズ表示
- フェーズ別残り時間の視覚化
- フェーズ別色分け表示

### 6. フェーズ管理システム
- 自動フェーズ遷移
- フェーズ別プレイヤー装備管理
- フェーズ別ゲームルール適用
- フェーズ別時間管理

### 7. ゲーム制限
- 防具の取り外し禁止（戦闘フェーズのみ）
- ブロック破壊・設置制限（フェーズ別）
- アイテムドロップ制限

### 8. PVP強制有効化システム
- **戦闘フェーズ中のPVP**: server.propertiesやWorldGuardの設定を無視して強制有効
- **対象**: ゲーム参加者同士のみ（非参加者への攻撃は元の設定に従う）
- **優先度**: 最高優先度（EventPriority.HIGHEST）で処理
- **設定**: config.ymlの`force-pvp`で制御（デフォルト: true）
- **適用範囲**: 戦闘フェーズのみ（建築・結果フェーズは元の設定）

## 設定ファイル

### グローバル設定（config.yml）
```yaml
# プラグイン全体の設定
plugin:
  auto-save: true           # ゲーム設定の自動保存
  max-games: -1             # 最大ゲーム数（-1で無制限）
  force-pvp: true           # 戦闘フェーズ中のPVP強制有効化
  
# デフォルトゲーム設定
default-game:
  min-players: 2            # 自動開始する最小プレイヤー数
  max-players-per-team: 10  # チーム最大人数
  respawn-delay: 5          # リスポーン遅延（秒）

# デフォルトフェーズ設定
default-phases:
  build-duration: 300           # 建築フェーズ時間（秒）
  build-phase-gamemode: "ADVENTURE"  # 建築フェーズのゲームモード
  combat-duration: 600          # 戦闘フェーズ時間（秒）
  result-duration: 60           # リザルトフェーズ時間（秒）※固定値
```

### ゲーム個別設定（games/<ゲーム名>.yml）
```yaml
# ゲーム基本情報
name: "example_game"
created: "2025-01-05T12:00:00"
world: "world"

# チーム設定
teams:
  red:
    flag-location: 
      x: 100
      y: 64
      z: 0
    spawn-location:
      x: 90
      y: 64
      z: 0
  blue:
    flag-location:
      x: -100
      y: 64
      z: 0
    spawn-location:
      x: -90
      y: 64
      z: 0

# ゲーム固有設定（省略時はデフォルト値を使用）
settings:
  min-players: 4
  max-players-per-team: 8
  phases:
    build-duration: 240
    combat-duration: 480
```

### エフェクト設定
```yaml
effects:
  flag-beacon:
    enabled: true           # 旗ビーコン効果
    particles:
      enabled: true         # パーティクル効果
      type: "DUST"
      count: 5
  flag-carrier:
    glow: true             # 旗キャリア発光
```

### ワールド設定
```yaml
world:
  disable-block-break: true  # ブロック破壊禁止
  disable-block-place: true  # ブロック設置禁止
  disable-item-drop: true    # アイテムドロップ禁止
  
  # Spawn area protection
  spawn-protection:
    enabled: true         # スポーン保護を有効化
    radius: 5            # 保護半径（ブロック）
    height: 3            # 保護高度（上下ブロック数）
    min-flag-spawn-distance: 15  # 旗とスポーン間の最小距離
```

## 開発・ビルド手順

### 前提条件
- Java 21
- Gradle 8.3+
- Paper Server 1.21.5

### ビルドコマンド
```bash
# プロジェクトビルド
./gradlew build

# プラグインJAR作成
./gradlew shadowJar

# 開発サーバー起動
./gradlew runServer
```

### 生成ファイル
- `build/libs/easy_ctf-1.0-SNAPSHOT-all.jar` - プラグインファイル

## 主要クラス詳細

### Main.kt
- プラグインのエントリーポイント
- GameManagerの初期化
- コマンド・リスナーの登録

### GameManager.kt
- 複数ゲームインスタンスの管理
- ゲーム間の独立性保証
- プレイヤーの参加ゲーム追跡
- ゲーム設定の永続化管理
- 対話形式ゲーム作成の状態管理

### Game.kt（新規）
- 個別ゲームインスタンスの実装
- 3フェーズシステムの制御
- プレイヤー・チーム情報の管理
- フェーズ別装備・ルール管理
- スコアボード・BossBarの制御
- 旗システムの実装

### CTFCommand.kt
- 全コマンドの処理
- 権限チェック
- タブ補完機能（ゲーム名、プレイヤー名）
- 視線先ブロックの検出

### GameListener.kt
- ゲーム中のイベント処理
- プレイヤー移動・死亡・アイテム操作
- 防具保護システム
- 複数ゲーム間のイベント分離

## 今後の拡張予定

1. **統計システム**: プレイヤー個人成績の追跡
2. **ショップ**: 経済機能をいれて、アイテムを購入できる
3. **マップ管理**: 複数マップの対応
4. **アビリティシステム**: 特殊能力の追加
5. **データベース連携**: 永続化データの管理
6. **Web API**: 外部システムとの連携

## トラブルシューティング

### よくある問題

1. **コンパイルエラー**: Kotlin 1.9.22とJava 21の組み合わせを確認
2. **権限エラー**: plugin.ymlの権限設定を確認
3. **スコアボードが表示されない**: GameManagerの初期化を確認

### デバッグ設定
```yaml
debug:
  enabled: true
  log-level: "INFO"
```

## ライセンス

このプロジェクトは学習・研究目的で作成されています。