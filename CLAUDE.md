# EasyCTF - Minecraft Capture The Flag Plugin

## プロジェクト概要

EasyCTFは、Minecraft Paper Server用のCapture The Flag（CTF）プラグインです。複数のCTFゲームを同時に管理・実行でき、各ゲームでRed TeamとBlue Teamに分かれて旗を取り合う対戦を行います。マッチシステムにより複数ゲームを連続して実行し、最終的な勝者を決定できます。

## 主要な変更点（最新版）

### 1. インターバルの削除
- 建築フェーズから戦闘フェーズへの移行が即座に実行
- マッチ間のインターバルを削除し、スムーズな進行を実現
- ゲーム終了後の結果表示時間のみ維持

### 2. チームブロックシステムの簡素化
- チームブロックをコンクリートのみに統一（ガラスブロックを削除）
- 赤チーム: 赤コンクリート
- 青チーム: 青コンクリート
- 中立ブロック: 白コンクリート（クォーツブロック）

### 3. ビーコン周辺のダメージエリア
- ビーコン（旗）周囲3x3マスが敵チームのダメージエリアとして機能
- 敵陣ブロックと同様のシールド減少効果を適用
- 戦略的な防衛要素を追加

### 4. 自陣での空腹度回復
- 自陣ブロックまたは自陣ビーコン周囲で空腹度が自動回復
- 回復速度: 1秒ごとに1ポイント
- サチュレーションも同時に回復

### 5. マップシステムの改善
- マップ保存時にコンテナブロック（チェスト等）の中身をクリア
- ビーコンに自動的にチーム色のガラスを設置
- 旗検出ロジックを距離ベースに改善

## プロジェクト構成

```
src/main/kotlin/com/hacklab/ctf/
├── Main.kt                      # メインプラグインクラス
├── Game.kt                      # 個別ゲームの実装
├── Match.kt                     # マッチシステムの実装
├── commands/
│   └── CTFCommandNew.kt         # コマンド処理
├── listeners/
│   ├── GameListenerNew.kt       # ゲームイベント処理
│   └── ChatListener.kt          # チャット処理
├── managers/
│   ├── GameManagerNew.kt        # ゲーム状態管理
│   ├── EquipmentManager.kt      # 装備管理
│   └── LanguageManager.kt       # 多言語対応
├── shop/
│   ├── ShopManager.kt           # ショップシステム
│   └── ShopItem.kt              # ショップアイテム定義
├── map/
│   ├── CompressedMapManager.kt  # マップ保存・復元
│   ├── MapScanner.kt            # マップスキャン・検証
│   └── MapRegion.kt             # マップ領域定義
├── world/
│   └── WorldManager.kt          # テンポラリワールド管理
└── utils/
    ├── GameState.kt             # ゲーム状態定義
    ├── GamePhase.kt             # ゲームフェーズ定義
    ├── Team.kt                  # チーム定義
    └── MatchMode.kt             # マッチモード定義

src/main/resources/
├── plugin.yml                   # プラグイン設定
├── config.yml                   # グローバル設定
├── lang_ja.yml                  # 日本語メッセージ
└── lang_en.yml                  # 英語メッセージ
```

## 技術スタック

- **言語**: Kotlin 1.9.22
- **プラットフォーム**: Minecraft Paper API 1.21.5
- **ビルドツール**: Gradle with Kotlin DSL
- **JVM**: Java 21

## 主要システム

### 1. ゲームフロー

#### フェーズ進行（インターバルなし）
1. **BUILD PHASE（建築フェーズ）** → 即座に移行 → **COMBAT PHASE（戦闘フェーズ）**
2. 戦闘フェーズ終了 → 結果表示（15秒） → 次のゲームまたは終了

#### マッチシステム
- 複数ゲームを連続実行（インターバルなし）
- 各ゲーム終了後、即座に次のゲームへ移行
- 最終結果表示のみ時間を確保

### 2. ダメージ・回復システム

#### 敵陣でのダメージ
**対象エリア**:
- 敵チームの色付きコンクリートブロック上
- 敵チームのビーコン周囲3x3マス

**効果**:
- シールドが徐々に減少（2.0/秒）
- シールドが0になるとダメージを受ける（1.5ダメージ/秒）
- 満腹度が減少して自動回復を防ぐ

#### 自陣での回復
**対象エリア**:
- 自チームの色付きコンクリートブロック上
- 自チームのビーコン周囲3x3マス

**効果**:
- 空腹度が1ポイント/秒で回復
- サチュレーションも0.5ポイント/秒で回復
- 最大20（満腹）まで回復

### 3. ブロックシステム

#### チームブロック（コンクリートのみ）
- **赤チーム**: RED_CONCRETE
- **青チーム**: BLUE_CONCRETE
- **中立**: WHITE_CONCRETE（切断されたブロック）

#### ブロック接続システム
- ブロックは自チームのビーコンまたは既存ブロックに接続必須
- 接続が切れたブロックは自動的に中立化（白色に変化）
- ビーコン周囲の鉄ブロックがルートノードとして機能

### 4. マップ管理システム

#### テンポラリワールド
- ゲーム開始時に専用の空ワールド（`ctf_temp_<ゲーム名>`）を作成
- VoidWorldGeneratorで完全に空のワールドを生成
- マップデータを復元して独立した環境を提供

#### マップ保存・復元
- **保存形式**: GZIP圧縮 + Base64エンコード
- **コンテナ処理**: チェスト等の中身は復元時にクリア
- **ビーコン処理**: 自動的にチーム色のガラスを設置

#### 自動検出システム
- **赤コンクリート**: 赤チームスポーン（複数可）
- **青コンクリート**: 青チームスポーン（複数可）
- **ビーコン**: 距離ベースでチーム判定（スポーンに近い方）

### 5. ショップシステム

#### 通貨システム
- チーム共有通貨（G）
- 初期通貨: 50G
- キル報酬: 10G（旗キャリア: 20G）
- キャプチャ報酬: 30G
- フェーズ終了ボーナス: 50G

#### 割引システム
スコア差による負けチーム割引:
- 1点差: 10%
- 2点差: 20%
- 3点差: 30%
- 4点差以上: 40%

#### アイテムカテゴリ
- **武器**: 剣、斧、弓、盾
- **防具**: 各種防具セット
- **消耗品**: エンダーパール、金リンゴ、矢
- **建築ブロック**: コンクリート、木材、土、黒曜石、TNT等

#### 死亡時のアイテム処理
- **KEEP**: 死亡しても保持
- **DROP**: 死亡時にドロップ
- **DESTROY**: 死亡時に消失

### 6. 観戦者モード

#### 機能
- `/ctf spectator [ゲーム名]` で観戦者として参加
- 自動的にSPECTATORゲームモードに設定
- 専用UIでゲーム情報を確認

#### 観戦者専用アイテム
- **統計表示（紙）**: 各プレイヤーのK/D/C統計
- **プレイヤー追跡（コンパス）**: プレイヤー一覧とテレポート
- **旗位置表示**: 両チームの旗状態確認
- **チームスポーンテレポート（ベッド）**: 各チームのスポーン地点へ移動

## ゲーム仕様

### チーム構成
- **Red Team**: 赤チーム（最大10名）
- **Blue Team**: 青チーム（最大10名）
- **チーム割り当て**: 自動バランス（参加時に人数が少ない方に自動割り当て）

### ゲーム状態
- `WAITING`: プレイヤー待機中
- `STARTING`: ゲーム開始準備中
- `RUNNING`: ゲーム進行中
- `ENDING`: ゲーム終了処理中
- `CONFIGURING`: 対話形式での設定中

### ゲームフェーズ
1. **BUILD PHASE（建築フェーズ）**
   - 時間: デフォルト120秒（設定可能）
   - ゲームモード: ADVENTURE/SURVIVAL/CREATIVE（選択可能）
   - ショップアイテム使用可能
   - 戦闘は禁止
   - ブロック接続システム有効

2. **COMBAT PHASE（戦闘フェーズ）**
   - 時間: デフォルト120秒（設定可能）
   - CTF本戦、旗の奪取と得点
   - ショップ使用可能（スポーン地点付近のみ）
   - PvP強制有効化（設定可能）
   - 敵陣ダメージシステム有効
   - 自陣回復システム有効

3. **INTERMISSION PHASE（作戦会議フェーズ）**
   - 時間: デフォルト15秒（設定可能）
   - 試合結果の表示
   - マッチモード時は次ゲームへの準備

### 旗システム
- **実装**: ビーコン（3x3の鉄ブロックベース付き）
- **旗取得**: 敵ビーコンに1.5ブロック以内で接近
- **旗キャリア効果**: 発光、移動制限（エンダーパール等使用不可）
- **得点条件**: 自陣の旗がある状態で敵旗を持ち帰る
- **ドロップ処理**: 死亡時にその場にドロップ（30秒で自動復帰）

### 初期装備
- 石の剣
- 石の斧
- パン×8
- チーム色の革防具（変更不可）
- エメラルド（ショップアイテム）

## コマンド一覧

### 基本コマンド
| コマンド | 権限 | 説明 |
|---------|------|------|
| `/ctf create <ゲーム名>` | `ctf.admin` | 新規ゲーム作成（対話形式） |
| `/ctf update <ゲーム名>` | `ctf.admin` | 既存ゲーム設定の更新 |
| `/ctf delete <ゲーム名>` | `ctf.admin` | ゲーム削除 |
| `/ctf list` | `ctf.use` | 全ゲーム一覧表示 |
| `/ctf start <ゲーム名> [match] [数]` | `ctf.admin` | ゲーム/マッチ開始 |
| `/ctf stop <ゲーム名>` | `ctf.admin` | 強制停止 |
| `/ctf join <ゲーム名>` | `ctf.use` | ゲーム参加 |
| `/ctf leave` | `ctf.use` | ゲーム離脱 |
| `/ctf team [red\|blue]` | `ctf.use` | チーム確認・変更 |
| `/ctf spectator [ゲーム名]` | `ctf.use` | 観戦者として参加 |
| `/ctf status [ゲーム名]` | `ctf.use` | ゲーム状態確認 |
| `/ctf info <ゲーム名>` | `ctf.use` | ゲーム詳細情報表示 |

### マップ設定コマンド
| コマンド | 権限 | 説明 |
|---------|------|------|
| `/ctf setpos1 <ゲーム名>` | `ctf.admin` | マップ領域始点設定 |
| `/ctf setpos2 <ゲーム名>` | `ctf.admin` | マップ領域終点設定 |
| `/ctf savemap <ゲーム名>` | `ctf.admin` | マップ保存（自動検出） |
| `/ctf setflag <ゲーム名> <red\|blue>` | `ctf.admin` | 旗位置設定 |
| `/ctf setspawn <ゲーム名> <red\|blue>` | `ctf.admin` | スポーン地点設定 |
| `/ctf addspawn <ゲーム名> <red\|blue>` | `ctf.admin` | スポーン地点追加 |
| `/ctf removespawn <ゲーム名> <red\|blue> <番号>` | `ctf.admin` | スポーン地点削除 |
| `/ctf listspawns <ゲーム名>` | `ctf.admin` | スポーン地点一覧表示 |

## 設定ファイル

### config.yml（主要設定）
```yaml
# 言語設定
language: "ja"  # "en" または "ja"

# デフォルトゲーム設定
default-game:
  min-players: 2
  max-players-per-team: 10
  respawn-delay: 5
  force-pvp: true

# フェーズ設定
default-phases:
  build-duration: 120        # 建築フェーズ（秒）
  build-phase-gamemode: "ADVENTURE"
  combat-duration: 120       # 戦闘フェーズ（秒）
  result-duration: 15        # 結果表示（秒）

# シールドシステム
shield:
  enabled: true
  max-shield: 100
  decrease-rate: 2.0         # 敵陣での減少速度
  recovery-rate: 5.0         # 自陣での回復速度
  damage-amount: 1.5         # シールド0時のダメージ
  damage-interval: 1000      # ダメージ間隔（ミリ秒）
  warning-threshold: 40      # 警告閾値
  critical-threshold: 20     # 危険閾値

# 通貨設定
currency:
  name: "G"
  initial: 50
  phase-end-bonus: 50
  kill-reward: 10
  carrier-kill-reward: 20
  capture-reward: 30

# ショップ設定
shop:
  enabled: true
  use-range: 15
  discount:
    1-point: 0.1
    2-point: 0.2
    3-point: 0.3
    4-point-plus: 0.4
```

## ビルド・実行

### 前提条件
- Java 21
- Gradle 8.3+
- Paper Server 1.21.5

### ビルドコマンド
```bash
# プロジェクトビルド
./gradlew build

# プラグインJAR作成
./gradlew shadowJar

# 開発サーバー起動
./gradlew runServer
```

### 生成ファイル
- `build/libs/easy_ctf-1.0-SNAPSHOT-all.jar`

## トラブルシューティング

### よくある問題
1. **マップが保存されない**: 領域設定（pos1/pos2）を確認
2. **ビーコンの色が設定されない**: 旗位置が正しく設定されているか確認
3. **ダメージを受けない**: シールドシステムが有効か確認
4. **空腹度が回復しない**: 自陣ブロック上にいるか確認
5. **ショップが開かない**: スポーン地点から15ブロック以内で使用
6. **通貨が共有されない**: 同じチームか確認

### デバッグ
- サーバーログで `[EasyCTF]` タグを確認
- `/ctf status` でゲーム状態を確認
- `/ctf info <ゲーム名>` で詳細情報を表示

## 今後の拡張予定

1. **統計システム**: 詳細な個人成績とランキング
2. **カスタムアビリティ**: 特殊能力やクラスシステム
3. **マップエディタ**: GUI ベースのマップ作成ツール
4. **トーナメントモード**: 複数チームでの大会形式
5. **API連携**: 外部システムとの統計連携

## ライセンス

このプロジェクトは学習・研究目的で作成されています。