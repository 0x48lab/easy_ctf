# EasyCTF プラグイン技術仕様書

## システム概要

EasyCTFは、Minecraft Paper Server 1.21.5向けのCapture The Flag（CTF）ゲームモードプラグインです。Kotlin 1.9.22で開発され、Java 21環境で動作します。複数のCTFゲームを同時に管理・実行でき、各ゲームでRed TeamとBlue Teamに分かれて旗を取り合う対戦を行います。

## 主要機能

### 1. ゲーム管理システム

#### ゲーム状態（GameState）
- **WAITING**: プレイヤー待機中
- **STARTING**: ゲーム開始準備中
- **RUNNING**: ゲーム進行中
- **ENDING**: ゲーム終了処理中
- **CONFIGURING**: 対話形式での設定中

#### ゲームフェーズ（GamePhase）
- **BUILD**: 建築フェーズ
- **COMBAT**: 戦闘フェーズ
- **INTERMISSION**: 作戦会議フェーズ

#### ゲーム設定
- 最小プレイヤー数: デフォルト2名（設定可能）
- チーム最大人数: デフォルト10名（設定可能）
- 自動開始機能: 最小人数到達で30秒カウントダウン後に開始

### 2. マッチシステム

#### マッチモード
- **FIXED_ROUNDS**: 固定ラウンドモード（指定回数のゲームを実施）

#### マッチ機能
- 複数ゲームの連続実行
- ゲーム間インターバル: デフォルト15秒（設定可能）
- プレイヤーの自動引き継ぎ
- マッチ全体のスコア管理
- BossBarによるマッチ進行状況表示
- 同点時の判定: 色ブロック設置数で決定

### 3. チーム管理

#### チーム構成
- **RED Team**: 赤チーム（最大10名）
- **BLUE Team**: 青チーム（最大10名）

#### チーム割り当て
- 自動バランス機能（参加時に人数が少ない方に自動割り当て）
- 手動チーム変更（ゲーム開始前のみ）

### 4. 通貨システム

#### チーム共有通貨（G）
- 初期通貨: 50G（設定可能）
- フェーズ終了ボーナス: 50G

#### 通貨獲得方法
- キル報酬: 10G
- キルアシスト報酬: 5G
- 旗キャリアキル報酬: 20G
- 旗キャリアキルアシスト報酬: 10G
- キルストリークボーナス:
  - 2連続キル: +5G
  - 3連続キル: +10G
  - 4連続キル: +15G
  - 5連続キル以上: +20G
- キャプチャー報酬: 30G
- キャプチャーアシスト報酬: 15G

### 5. ショップシステム

#### カテゴリー
- **武器**: 木〜ネザライトの剣・斧、弓、盾、エンチャント武器
- **消耗品**: パン、ステーキ、金のリンゴ、エンダーパール、矢
- **ブロック**: フェンス、鉄格子、ガラス板、はしご、TNTなど

#### 特殊機能
- 死亡時の挙動設定（KEEP/DROP/DESTROY）
- 購入制限（プレイヤー別・チーム別）
- スコア差による負けチーム割引:
  - 1点差: 10%割引
  - 2点差: 20%割引
  - 3点差: 30%割引
  - 4点差以上: 40%割引

### 6. フェーズ別ゲームプレイ

#### 建築フェーズ（BUILD PHASE）
- 時間: デフォルト120秒（設定可能）
- ゲームモード選択可能:
  - ADVENTURE: ブロック設置・破壊不可
  - SURVIVAL: 通常の建築・破壊（デフォルト）
  - CREATIVE: 無制限建築、飛行可能
- PvP無効
- ショップ使用可能
- チーム色の無限ブロック提供

#### 戦闘フェーズ（COMBAT PHASE）
- 時間: デフォルト120秒（設定可能）
- PvP強制有効化
- ブロック設置禁止
- ブロック破壊は可能（アイテムドロップなし）
- ショップ使用可能（スポーン地点から15ブロック以内）
- 旗の奪取と得点
- 敵陣シールドシステム（敵チームブロック上で継続ダメージ）

#### リザルトフェーズ（INTERMISSION）
- 時間: 15秒（固定）
- 全行動禁止
- 結果表示とMVP発表

### 7. 旗システム

#### 実装詳細
- ビーコン + チーム色のガラスブロックで表現
- 3x3の鉄ブロックベース付き
- 旗取得範囲: 1.5ブロック以内

#### 旗キャリア効果
- 発光効果（グロー）
- エンダーパール使用不可
- エリトラ使用不可
- 乗り物使用不可

#### 旗ドロップ・回収
- 死亡時: その場にドロップ（15秒で自動返却）
- 奈落死・炎上死: 即座に元の位置へ返却
- 地面のアイテムとして表示（専用の名前付き）

### 8. マップシステム

#### テンポラリワールド機能
- ゲーム開始時に専用ワールド作成（`ctf_temp_<ゲーム名>`）
- プレイヤーを自動転送
- ゲーム終了時に元のワールドへ戻し、テンポラリワールド削除

#### マップ保存・復元
- 圧縮形式（GZIP + Base64）で効率的に保存
- マップ範囲指定（pos1/pos2）
- 自動検出機能:
  - 赤コンクリート: 赤チームスポーン
  - 青コンクリート: 青チームスポーン
  - ビーコン+赤ガラス: 赤チーム旗
  - ビーコン+青ガラス: 青チーム旗
- WorldEdit連携対応

### 9. プレイヤー統計

#### 記録される統計
- キル数・デス数・K/D比
- キルストリーク
- 旗キャプチャー数
- 旗取得数
- 旗防衛数（旗キャリアキル）
- 使用金額
- ブロック設置数
- アシスト数

#### MVP表彰
- 最多キル
- 最多キャプチャー
- 最多防衛
- 最多アシスト
- 最多建築
- 最多消費
- 最少デス

### 10. ブロック管理システム

#### ブロック設置制限
- チームカラーブロックから3ブロック以内のみ設置可能
- 旗から3ブロック以内は制限なし
- ツリー構造で管理（親ブロックとの接続）

#### ブロック破壊時の処理
- 接続が切れたブロックは白色に変化
- チームカラーブロックの破壊はドロップなし

#### 敵陣シールドシステム
- 敵チームのブロック上に立つとシールドが減少
- シールド0で継続ダメージ（2秒ごとに1ダメージ）
- 敵陣から離れるとシールド回復

## コマンド仕様

### 基本コマンド構造
`/ctf <サブコマンド> [引数...]`

### プレイヤー用コマンド（権限: ctf.use）
- `list` - 全ゲーム一覧表示
- `join <ゲーム名>` - ゲーム参加
- `leave` - 現在のゲームから離脱
- `team [red|blue]` - チーム確認・変更
- `status [ゲーム名]` - ゲーム状態確認
- `info <ゲーム名>` - ゲーム設定の詳細表示

### 管理者用コマンド（権限: ctf.admin）
- `create <ゲーム名>` - 新規ゲーム作成（対話形式）
- `update <ゲーム名>` - 既存ゲーム設定の更新
- `delete <ゲーム名>` - ゲーム削除
- `start <ゲーム名> [single|match] [ゲーム数]` - ゲーム/マッチ開始
- `stop <ゲーム名>` - ゲーム/マッチ強制停止
- `setflag <ゲーム名> <red|blue>` - 旗位置設定
- `setspawn <ゲーム名> <red|blue>` - スポーン地点設定
- `setpos1 [ゲーム名]` - マップ領域の始点設定
- `setpos2 [ゲーム名]` - マップ領域の終点設定
- `savemap <ゲーム名>` - マップ保存（自動検出）

## ゲームフロー

### ゲーム開始前
1. 管理者がゲーム作成（`/ctf create`）
2. プレイヤーが参加（`/ctf join`）
3. 自動またはマニュアルでゲーム開始

### ゲーム中の流れ
1. **建築フェーズ**
   - チーム色の無限ブロック配布
   - 防御施設の構築
   - ショップでアイテム購入可能

2. **戦闘フェーズ**
   - 敵陣の旗を奪取
   - 自陣に持ち帰って得点
   - リスポーン遅延（死亡回数に応じて増加）

3. **リザルトフェーズ**
   - 勝敗表示
   - MVP発表
   - 次ゲームへの準備

### ゲーム終了条件
- 戦闘フェーズ時間切れ
- 管理者による強制停止

## 設定項目（config.yml）

### 言語設定
- `language`: ja/en

### ゲーム設定
- `default-game.min-players`: 最小プレイヤー数
- `default-game.max-players-per-team`: チーム最大人数
- `default-game.respawn-delay-base`: 基本リスポーン遅延
- `default-game.respawn-delay-per-death`: 死亡ごとの追加遅延
- `default-game.respawn-delay-max`: 最大リスポーン遅延

### フェーズ設定
- `default-phases.build-duration`: 建築フェーズ時間
- `default-phases.build-phase-gamemode`: 建築時のゲームモード
- `default-phases.combat-duration`: 戦闘フェーズ時間

### マッチ設定
- `match.default-target`: デフォルトゲーム数
- `match.interval-duration`: ゲーム間インターバル

### 通貨・ショップ設定
- 初期通貨、各種報酬額
- ショップ使用可能範囲
- スコア差による割引率

## ゲームルール

### 勝利条件
- 戦闘フェーズ終了時により多くのポイントを獲得したチーム
- 同点の場合は引き分け（マッチでは色ブロック数で判定）

### 得点方法
- 敵の旗を自陣の旗がある状態で持ち帰る: 1点

### 制限事項
- 革防具のみ装備可能
- 戦闘フェーズ中は防具の脱着不可
- エンダーパール・エリトラ・乗り物は旗所持時使用不可

### インベントリ管理
- **新規ゲーム開始時**: インベントリクリア
- **マッチの最初のゲーム**: インベントリクリア
- **マッチの2ゲーム目以降**: インベントリ保持
- **フェーズ間の移行**: インベントリ保持（建築→戦闘→リザルト）
- **ゲーム終了時**: マッチモードでは保持、通常モードではクリア

## 技術仕様

### プラグイン構成
- メインクラス: `com.hacklab.ctf.Main`
- ゲーム管理: `GameManager`（シングルトン）
- イベント処理: `GameListenerNew`
- コマンド処理: `CTFCommandNew`

### データ永続化
- ゲーム設定: YAML形式（`plugins/EasyCTF/games/<ゲーム名>.yml`）
- マップデータ: 圧縮形式（`plugins/EasyCTF/maps/<ゲーム名>.yml`）

### パフォーマンス最適化
- スコアボード更新: 20tick（1秒）間隔
- マップデータ圧縮によるファイルサイズ削減
- 非同期タスクの活用

## 更新履歴

### 最新の修正内容
- `&y`の色コードバグを`&e`に修正
- マッチゲーム間およびフェーズ間でアイテムが保持されるように修正
- 3ゲーム後にプレイヤーがワールドに放り出される問題を修正